<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xmas Dream | Custom Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;700&family=Inter:wght@300;500&family=Mountains+of+Christmas:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Inter', sans-serif; user-select: none; }
        .cinzel { font-family: 'Cinzel', serif; }
        .songti { font-family: 'Noto Serif SC', serif; }
        
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 0; }
        .ui-layer { position: absolute; z-index: 20; pointer-events: none; width: 100%; height: 100%; }
        .interactive { pointer-events: auto !important; }
        
        .glass-panel {
            background: rgba(10, 10, 10, 0.75);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
            transition: all 0.3s ease;
        }

        .icon-btn {
            width: 44px; height: 44px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.6); display: flex; align-items: center; justify-content: center;
            transition: all 0.3s; cursor: pointer; backdrop-filter: blur(4px); font-size: 1.1rem;
        }
        .icon-btn:hover { background: rgba(255, 215, 0, 0.2); color: #FFD700; border-color: rgba(255, 215, 0, 0.5); transform: scale(1.1); }

        .card-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #FFD700; font-family: 'Mountains of Christmas', 'Noto Serif SC', sans-serif; padding: 8px 12px; border-radius: 4px;
            outline: none; transition: all 0.3s; margin-bottom: 8px; font-size: 1rem; font-weight: 700;
        }
        .card-input:focus { border-color: #FFD700; background: rgba(255,215,0,0.05); }
        .card-input::placeholder { color: rgba(255,255,255,0.3); font-style: italic; }
        
        input[type="color"] { appearance: none; -webkit-appearance: none; border: none; width: 24px; height: 24px; border-radius: 50%; overflow: hidden; cursor: pointer; padding: 0; background: none; }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: 1px solid rgba(255,255,255,0.3); border-radius: 50%; }
    </style>

    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react/jsx-runtime": "https://esm.sh/react@18.2.0/jsx-runtime",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "three": "https://esm.sh/three@0.160.0",
            "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.14?external=react,react-dom,three",
            "@react-three/drei": "https://esm.sh/@react-three/drei@9.96.1?external=react,react-dom,three,@react-three/fiber",
            "@react-three/postprocessing": "https://esm.sh/@react-three/postprocessing@2.16.0?external=react,react-dom,three,@react-three/fiber",
            "postprocessing": "https://esm.sh/postprocessing@6.34.1?external=three"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useRef, useEffect, useMemo, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame, useThree } from '@react-three/fiber';
        import { Environment, ContactShadows, Sparkles, Image, Stars, Text } from '@react-three/drei';
        import { EffectComposer, Bloom, Vignette, Noise } from '@react-three/postprocessing';

        const PRESETS = {
            CLASSIC: { id: 'CLASSIC', name: 'Classic Gold', bg: '#140505', leaf: '#003311', gift: '#8a0303', ornament: '#FFD700', ribbon: '#FFD700', light: '#ffb300', env: 'sunset', roughness: 0.2, metalness: 0.5, bloomInt: 0.9, bloomThresh: 0.5 },
            FROZEN: { id: 'FROZEN', name: 'Frozen', bg: '#02050a', leaf: '#cceeff', gift: '#ffffff', ornament: '#5D8AA8', ribbon: '#FFFFFF', light: '#e0ffff', env: 'warehouse', roughness: 0.5, metalness: 0.2, bloomInt: 0.5, bloomThresh: 0.7 },
            DREAMY: { id: 'DREAMY', name: 'Dreamy Pink', bg: '#1a050d', leaf: '#ffbad0', gift: '#fff0f5', ornament: '#e6e6fa', ribbon: '#FFB6C1', light: '#ffb6c1', env: 'city', roughness: 0.6, metalness: 0.1, bloomInt: 0.6, bloomThresh: 0.6 },
            VINTAGE: { id: 'VINTAGE', name: 'Vintage', bg: '#1a0d08', leaf: '#8c4830', gift: '#4a0e0e', ornament: '#ffcc99', ribbon: '#FFAA66', light: '#ffaa66', env: 'sunset', roughness: 0.5, metalness: 0.4, bloomInt: 0.7, bloomThresh: 0.6 }
        };

        const COUNT_LEAVES = 7500;
        const COUNT_RIBBON = 600;
        const MUSIC_URL = "https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3";

        const getTreePos = (i, total) => {
            const ratio = i / total;
            const h = ratio * 24 - 12;
            const maxRadius = 9.5;
            const radius = Math.max(0, (1 - ratio) * maxRadius);
            const angle = i * 0.15 + (Math.random() * Math.PI * 0.5);
            return { pos: [Math.cos(angle) * radius, h, Math.sin(angle) * radius], type: i%35===0?'gift':i%50===0?'ornament':'leaf' };
        };

        const getRibbonPos = (i, total) => {
            const ratio = i / total;
            const h = ratio * 18 - 9;
            const angle = ratio * 6 * Math.PI;
            const radius = ((1 - ratio) * (10.5 - 1.5)) + 1.5;
            return [Math.cos(angle) * radius, h, Math.sin(angle) * radius];
        };

        const getExplodePos = () => {
            const r = 35 + Math.random() * 20;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);
            return [r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi)];
        };

        const createStarShape = () => {
            const shape = new THREE.Shape();
            const points = 5;
            for (let i = 0; i < points * 2; i++) {
                const r = i % 2 === 0 ? 1.2 : 0.5;
                const a = (i / 10) * Math.PI * 2;
                if (i === 0) shape.moveTo(Math.cos(a+Math.PI/2)*r, Math.sin(a+Math.PI/2)*r);
                else shape.lineTo(Math.cos(a+Math.PI/2)*r, Math.sin(a+Math.PI/2)*r);
            }
            shape.closePath();
            return shape;
        };

        function Greeting3D({ to, message, capturing }) {
            const viewport = useThree((state) => state.viewport);
            const isMobile = viewport.width < 25;

            // ä¸­æ–‡ä½¿ç”¨ Noto Serif SC
            const fontUrlChinese = "https://fonts.gstatic.com/s/notoserifsc/v34/H4cyBXePl9DZ0Xe7gG9cyOj7uK2-n-D2rd4FY7SCqyWv.ttf";

            // è‹±æ–‡ä½¿ç”¨ Mountains of Christmasï¼ˆåœ£è¯ä¸»é¢˜ï¼‰
            const fontUrlEnglish = "https://fonts.gstatic.com/s/mountainsofchristmas/v24/3y9z6a4zcCnn5X0FDyrKi2ZRUBIy8uxoUo7eBGqJFPs.ttf";

            // æ£€æµ‹æ–‡æœ¬æ˜¯å¦åŒ…å«ä¸­æ–‡
            const hasChinese = (text) => /[\u4e00-\u9fa5]/.test(text);

            // æ ¹æ®å†…å®¹é€‰æ‹©å­—ä½“
            const toFont = to && hasChinese(to) ? fontUrlChinese : fontUrlEnglish;
            const messageFont = message && hasChinese(message) ? fontUrlChinese : fontUrlEnglish;

            // æˆªå›¾æ—¶éšè— 3D æ–‡å­—
            if (capturing) return null;

            const pos = isMobile ? [6, 12, 0] : [16, 6, 0];
            const scale = isMobile ? 0.6 : 1;

            return (
                <group position={pos} scale={scale}>
                    {to && <Text font={toFont} fontSize={1.8} color="#FFD700" position={[0, 3, 0]} anchorX="center" anchorY="middle" outlineWidth={0.02} outlineColor="#5a3d00">To: {to}</Text>}
                    {message && <Text font={messageFont} fontSize={1.2} color="#FFFFFF" position={[0, 0, 0]} anchorX="center" anchorY="top" maxWidth={isMobile ? 10 : 12} lineHeight={1.5} textAlign="center" outlineWidth={0.01} outlineColor="#000">{message}</Text>}
                </group>
            );
        }

        function RealStar({ mode, theme }) {
            const ref = useRef();
            const starShape = useMemo(() => createStarShape(), []);
            useFrame((state) => {
                const t = state.clock.elapsedTime;
                if (!ref.current) return;
                ref.current.rotation.y = t * 0.4;
                ref.current.position.y = THREE.MathUtils.lerp(ref.current.position.y, mode === 'TREE' ? 14 : 35, 0.05);
                const s = mode === 'TREE' ? 1 : 0.01;
                ref.current.scale.lerp(new THREE.Vector3(s, s, s), 0.1);
            });
            return (
                <group ref={ref} position={[0, 14, 0]}>
                    <mesh><extrudeGeometry args={[starShape, { steps: 1, depth: 0.4, bevelEnabled: true, bevelThickness: 0.1, bevelSize: 0.1, bevelSegments: 2 }]} /><meshStandardMaterial color={theme.light} emissive={theme.ornament} emissiveIntensity={3} roughness={0.2} metalness={1} toneMapped={false} /></mesh>
                    <pointLight color={theme.light} intensity={15} distance={20} />
                    <Sparkles count={50} scale={8} size={10} speed={0.6} opacity={0.8} color="#FFF" />
                </group>
            );
        }

        function Decorations({ mode, theme, onClick }) {
            const leafRef = useRef(); const ribbonRef = useRef(); const giftRef = useRef(); const ornRef = useRef(); const dummy = useMemo(() => new THREE.Object3D(), []);
            const { leafData, giftData, ornData, ribbonData } = useMemo(() => {
                const l=[], g=[], o=[], r=[];
                for(let i=0; i<COUNT_LEAVES; i++){
                    const { pos, type } = getTreePos(i, COUNT_LEAVES);
                    const ePos = getExplodePos();
                    const data = { tPos: new THREE.Vector3(...pos), ePos: new THREE.Vector3(...ePos), cur: new THREE.Vector3(...ePos), speed: Math.random()*0.04+0.02, phase: Math.random()*Math.PI*2 };
                    if(type==='gift') g.push(data); else if(type==='ornament') o.push(data); else l.push(data);
                }
                for(let i=0; i<COUNT_RIBBON; i++){
                    const pos = getRibbonPos(i, COUNT_RIBBON);
                    r.push({ tPos: new THREE.Vector3(...pos), ePos: new THREE.Vector3(...getExplodePos()), cur: new THREE.Vector3(...getExplodePos()), speed: Math.random()*0.04+0.03, phase: i*0.1 });
                }
                return { leafData: l, giftData: g, ornData: o, ribbonData: r };
            }, []);

            useFrame((state) => {
                const t = state.clock.elapsedTime;
                const isTree = mode === 'TREE';
                const isFocus = mode === 'FOCUS';
                const update = (ref, data, scaleBase, type) => {
                    if(!ref.current) return;
                    data.forEach((d, i) => {
                        let target = (isTree && !isFocus) ? d.tPos : d.ePos;
                        d.cur.lerp(target, d.speed);
                        dummy.position.copy(d.cur);
                        if(type === 'ribbon' && isTree && !isFocus) {
                            dummy.position.y += Math.sin(t * 1.0 + d.phase) * 0.3;
                            dummy.rotation.set(t + d.phase, t + d.phase, 0);
                        } else dummy.rotation.set(t*0.3+d.phase, t*0.3+d.phase, 0);
                        let s = isFocus ? scaleBase * 0.1 : scaleBase;
                        dummy.scale.setScalar((Math.sin(t*2+d.phase)*0.15+1)*s);
                        dummy.updateMatrix();
                        ref.current.setMatrixAt(i, dummy.matrix);
                    });
                    ref.current.instanceMatrix.needsUpdate = true;
                };
                update(leafRef, leafData, 0.25); update(giftRef, giftData, 0.5); update(ornRef, ornData, 0.35); update(ribbonRef, ribbonData, 0.15, 'ribbon');
            });

            return (
                <group onClick={onClick}>
                    <instancedMesh ref={leafRef} args={[null,null,leafData.length]}><octahedronGeometry args={[1,0]}/><meshStandardMaterial color={theme.leaf} roughness={theme.roughness} metalness={theme.metalness}/></instancedMesh>
                    <instancedMesh ref={ribbonRef} args={[null,null,ribbonData.length]}><tetrahedronGeometry args={[1,0]}/><meshStandardMaterial color={theme.ribbon} emissive={theme.ribbon} emissiveIntensity={2} toneMapped={false}/></instancedMesh>
                    <instancedMesh ref={giftRef} args={[null,null,giftData.length]}><boxGeometry args={[1,1,1]}/><meshStandardMaterial color={theme.gift} roughness={0.4} metalness={0.4}/></instancedMesh>
                    <instancedMesh ref={ornRef} args={[null,null,ornData.length]}><sphereGeometry args={[1,16,16]}/><meshStandardMaterial color={theme.ornament} roughness={0.2} metalness={0.8} emissive={theme.ornament} emissiveIntensity={0.3}/></instancedMesh>
                </group>
            );
        }

        function Polaroid({ url, index, total, mode, focusId, setFocusId }) {
            const groupRef = useRef();
            const [hovered, setHover] = useState(false);
            const { treePos, explodePos, randomRot } = useMemo(() => {
                const ratio = index / total;
                const h = ratio * 18 - 9;
                const r = 8.5;
                const angle = index * 2.4;
                return { treePos: new THREE.Vector3(Math.cos(angle)*r, h, Math.sin(angle)*r), explodePos: new THREE.Vector3(...getExplodePos()), randomRot: [0, 0, (Math.random()-0.5)*0.4] };
            }, [index, total]);

            const dummy = useMemo(() => new THREE.Object3D(), []);

            useFrame((state, delta) => {
                if(!groupRef.current) return;
                const isFocus = mode === 'FOCUS' && focusId === index;
                const isOther = mode === 'FOCUS' && focusId !== index;
                
                if(isFocus) {
                    groupRef.current.position.lerp(new THREE.Vector3(0, 0, 45), delta * 5);
                    groupRef.current.rotation.set(0, 0, 0);
                    groupRef.current.quaternion.slerp(new THREE.Quaternion(0,0,0,1), delta * 10);
                } 
                else if(isOther) {
                    groupRef.current.position.lerp(explodePos, delta * 2.5);
                } 
                else {
                    let targetPos = mode === 'EXPLODE' ? explodePos : treePos;
                    groupRef.current.position.lerp(targetPos, delta * 2.5);
                    dummy.position.copy(groupRef.current.position);
                    dummy.lookAt(0, groupRef.current.position.y, 0);
                    dummy.rotateY(Math.PI);
                    dummy.rotateZ(randomRot[2]);
                    groupRef.current.quaternion.slerp(dummy.quaternion, 0.1);
                }

                let s = 2.0;
                if(isFocus) s=1.8;
                else if(isOther) s=0;
                else if(mode==='EXPLODE') s=1.5;
                else if(hovered) s=3.5;
                
                groupRef.current.scale.lerp(new THREE.Vector3(s,s,s), 0.1);
            });

            return (
                <group ref={groupRef} onClick={(e) => { e.stopPropagation(); setFocusId(focusId === index ? null : index); }} onPointerOver={(e) => { e.stopPropagation(); setHover(true); document.body.style.cursor='pointer'; }} onPointerOut={() => { setHover(false); document.body.style.cursor='auto'; }}>
                    <mesh position={[0,0,0]}><boxGeometry args={[1.2,1.5,0.05]}/><meshStandardMaterial color="#d8d8d8" roughness={0.95} metalness={0.05}/></mesh>
                    <Image url={url} position={[0,0.15,0.04]} scale={[1,1,1]} toneMapped={true} transparent opacity={0.95} />
                </group>
            );
        }

        function Scene({ photos, mode, setMode, focusId, setFocusId, theme, toName, message, capturing }) {
            const groupRef = useRef();
            
            useFrame((state) => {
                if (mode === 'FOCUS') return;
                const targetRot = state.clock.elapsedTime * 0.1;
                groupRef.current.rotation.y = THREE.MathUtils.lerp(groupRef.current.rotation.y, targetRot, 0.1);
            });

            return (
                <>
                    <Environment preset={theme.env} blur={0.6} />
                    <color attach="background" args={[theme.bg]} />
                    <ambientLight intensity={0.5} />
                    <spotLight position={[20,40,20]} intensity={180} color={theme.light} angle={0.5} penumbra={0.5} castShadow />
                    <spotLight position={[-20,10,-10]} intensity={100} color={theme.ornament} angle={0.6} />
                    <pointLight position={[0,-5,0]} intensity={20} color={theme.light} distance={30} decay={2} />
                    <Stars radius={100} count={3000} factor={4} fade speed={1} color={theme.light} />
                    
                    <group ref={groupRef}>
                        <Decorations mode={mode} theme={theme} onClick={(e) => { if(focusId !== null) setFocusId(null); else setMode(m => m === 'TREE' ? 'EXPLODE' : 'TREE'); }} />
                        <RealStar mode={mode} theme={theme} />
                        {photos.map((url, i) => (
                            <Polaroid key={i} url={url} index={i} total={photos.length} mode={mode} focusId={focusId} setFocusId={setFocusId} />
                        ))}
                    </group>

                    {focusId !== null && (
                        <Polaroid 
                            key={`focus-${focusId}`} 
                            url={photos[focusId]} 
                            index={focusId} 
                            total={photos.length} 
                            mode={mode} 
                            focusId={focusId} 
                            setFocusId={setFocusId} 
                        />
                    )}

                    <Greeting3D to={toName} message={message} capturing={capturing} />

                    <ContactShadows opacity={0.6} scale={50} blur={3} far={15} color={theme.bg} />
                    <EffectComposer disableNormalPass>
                        <Bloom luminanceThreshold={theme.bloomThresh} mipmapBlur intensity={theme.bloomInt} radius={0.5} />
                        <Noise opacity={0.02} />
                        <Vignette eskil={false} offset={0.1} darkness={1.0} />
                    </EffectComposer>
                </>
            );
        }

        function App() {
            const [photos, setPhotos] = useState([]);
            const [generated, setGenerated] = useState(false);
            const [mode, setMode] = useState('TREE');
            const [theme, setTheme] = useState(PRESETS.CLASSIC);
            const [focusId, setFocusId] = useState(null);
            const [toName, setToName] = useState("");
            const [message, setMessage] = useState("");
            const [audioPlaying, setAudioPlaying] = useState(false);
            const [activePanel, setActivePanel] = useState(null);
            const [capturing, setCapturing] = useState(false);  // æ–°å¢ï¼šæˆªå›¾çŠ¶æ€
            const audioRef = useRef(new Audio(MUSIC_URL));

            const resetTree = () => { setMode('TREE'); setFocusId(null); };
            
            const toggleAudio = () => {
                if(audioPlaying) audioRef.current.pause();
                else { audioRef.current.play(); audioRef.current.loop = true; }
                setAudioPlaying(!audioPlaying);
            };
            
            const handleScreenshot = () => {
                // ç¬¬ä¸€æ­¥ï¼šéšè— 3D æ–‡å­—
                setCapturing(true);

                // ç¬¬äºŒæ­¥ï¼šç­‰å¾…ä¸€å¸§è®© 3D æ–‡å­—æ¶ˆå¤±
                setTimeout(() => {
                    const canvas = document.querySelector('canvas');

                    // åˆ›å»ºä¸´æ—¶ Canvas
                    const tempCanvas = document.createElement('canvas');
                    const ctx = tempCanvas.getContext('2d');

                    // å›ºå®šä½¿ç”¨ç§»åŠ¨ç«¯ç«–ç‰ˆæ¯”ä¾‹ (9:16)
                    const CARD_RATIO = 9/16;

                    // è®¾ç½®å¯¼å‡ºåˆ†è¾¨ç‡ (å®½åº¦å›ºå®š 1080pxï¼Œé«˜åº¦è‡ªé€‚åº”)
                    const exportW = 1080;
                    const exportH = exportW / CARD_RATIO; // 1920px

                    tempCanvas.width = exportW;
                    tempCanvas.height = exportH;

                    // ========== 1. é«˜è´¨é‡æ£‰çº¸èƒŒæ™¯ (Organic Cotton Paper) ==========
                    ctx.fillStyle = '#FAF9F6';  // æ¸©æš–å¥¶ç™½è‰²
                    ctx.fillRect(0, 0, exportW, exportH);

                    // 1.5. ç»†è…»çº¸å¼ çº¹ç† (Subtle Paper Grain)
                    // ä½¿ç”¨Canvaså™ªç‚¹æ¨¡æ‹Ÿçº¸å¼ é¢—ç²’æ„Ÿï¼ˆæ›´ç»†è…»ï¼‰
                    for (let i = 0; i < 4000; i++) {
                        const x = Math.random() * exportW;
                        const y = Math.random() * exportH;
                        const opacity = Math.random() * 0.04 + 0.01; // 3-5% é€æ˜åº¦
                        const gray = Math.random() * 20 + 230; // 230-250 ç°åº¦ï¼Œæ›´æµ…
                        ctx.fillStyle = `rgba(${gray}, ${gray}, ${gray}, ${opacity})`;
                        ctx.fillRect(x, y, 1, 1);
                    }

                    // 1.6. ä¼˜é›…æš—è§’æ•ˆæœ (Elegant Vignette)
                    const vignette = ctx.createRadialGradient(exportW/2, exportH/2, exportH * 0.2, exportW/2, exportH/2, exportH * 0.9);
                    vignette.addColorStop(0, 'rgba(255, 255, 255, 0.15)'); // ä¸­å¿ƒæ›´äº®
                    vignette.addColorStop(1, 'rgba(230, 225, 215, 0.12)'); // è¾¹ç¼˜æ¸©æš–ç±³è‰²
                    ctx.fillStyle = vignette;
                    ctx.fillRect(0, 0, exportW, exportH);

                    // ========== 2. è®¡ç®—å›¾ç‰‡åŒºåŸŸ ==========
                    const marginTop = exportH * 0.08;      // é¡¶éƒ¨ç•™ç™½ 8%
                    const marginBottom = exportH * 0.22;   // åº•éƒ¨ç•™ç™½ 22%ï¼ˆç»™æ–‡å­—å’Œè£…é¥°ï¼‰
                    const marginSide = exportW * 0.06;     // ä¸¤ä¾§ç•™ç™½ 6%

                    const drawW = exportW - 2 * marginSide;
                    const drawH = exportH - marginTop - marginBottom;

                    // 3. è®¡ç®—æºå›¾åƒè£å‰ªåŒºåŸŸï¼ˆå±…ä¸­è£å‰ªï¼‰
                    const targetAspect = drawW / drawH;
                    const sourceAspect = canvas.width / canvas.height;

                    let sW, sH;

                    if (sourceAspect > targetAspect) {
                        sH = canvas.height;
                        sW = sH * targetAspect;
                    } else {
                        sW = canvas.width;
                        sH = sW / targetAspect;
                    }

                    const zoom = 0.75;
                    const sampleW = sW / zoom;
                    const sampleH = sH / zoom;

                    const sampleX = (canvas.width - sampleW) / 2;
                    const sampleY = (canvas.height - sampleH) / 2;

                    // ========== 4. "è´´åœ¨çº¸ä¸Šçš„ç…§ç‰‡" æ•ˆæœ (Mounted Photo) ==========
                    // 4.1. æŸ”å’ŒæŠ•å½±ï¼ˆæ¨¡æ‹Ÿç…§ç‰‡æµ®åœ¨çº¸ä¸Šï¼‰
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.12)';
                    ctx.shadowBlur = 30;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 12;
                    
                    // 4.2. ç»˜åˆ¶ç™½è‰²ç…§ç‰‡åº•æ¿ï¼ˆå¯é€‰ï¼Œåˆ›é€ "ç…§ç‰‡çº¸"æ•ˆæœï¼‰
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(marginSide - 4, marginTop - 4, drawW + 8, drawH + 8);
                    
                    // æ¸…é™¤é˜´å½±
                    ctx.shadowColor = 'transparent';
                    ctx.shadowBlur = 0;
                    ctx.shadowOffsetX = 0;
                    ctx.shadowOffsetY = 0;

                    // ========== 5. ç»˜åˆ¶3Dæˆªå›¾ (The Photo) ==========
                    // 5.1. ç»˜åˆ¶æˆªå›¾å†…å®¹ï¼ˆçº¯å‡€çš„åœ£è¯æ ‘ï¼‰
                    ctx.drawImage(canvas, sampleX, sampleY, sampleW, sampleH, marginSide, marginTop, drawW, drawH);

                    // 5.2. ä¼˜é›…ç»†è¾¹æ¡†ï¼ˆå¯é€‰ - æç®€é‡‘è‰²æè¾¹ï¼‰
                    ctx.strokeStyle = 'rgba(197, 160, 89, 0.25)';  // éå¸¸æ·¡çš„é‡‘è‰²
                    ctx.lineWidth = 1.5;
                    ctx.strokeRect(marginSide, marginTop, drawW, drawH);

                    // ========== 6. æç®€è£…é¥°å…ƒç´  (Minimalist Accents) ==========
                    // å»æ‰ç¹å¤çš„è§’è½èŠ±çº¹ï¼Œä¿æŒç®€æ´
                    
                    // å¯é€‰ï¼šæ·»åŠ éå¸¸æ·¡çš„é‡‘è‰²ç‚¹ç¼€ï¼ˆå‡å°‘æ•°é‡ï¼Œæ›´ä½è°ƒï¼‰
                    for (let i = 0; i < 30; i++) {
                        const x = Math.random() * exportW;
                        const y = Math.random() * exportH;
                        const size = Math.random() * 1.5 + 0.5;
                        const opacity = Math.random() * 0.08 + 0.02; // æ›´æ·¡
                        ctx.fillStyle = `rgba(197, 160, 89, ${opacity})`;
                        ctx.beginPath();
                        ctx.arc(x, y, size, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // ========== 7. ä¼˜é›…æ–‡å­—æ’ç‰ˆ (Elegant Typography) ==========
                    const textAreaTop = marginTop + drawH + 40;  // æ›´é è¿‘ç…§ç‰‡

                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';

                    // 7.1. æç®€è£…é¥°åˆ†éš”çº¿ï¼ˆæ·¡åŒ–æˆ–åˆ é™¤é›ªèŠ±ï¼‰
                    ctx.font = `24px "Mountains of Christmas", "Noto Serif SC", serif`;
                    ctx.fillStyle = 'rgba(197, 160, 89, 0.3)';  // æ›´æ·¡çš„é‡‘è‰²
                    ctx.fillText('âœ§', exportW / 2, textAreaTop);  // ç®€åŒ–ä¸ºå•ä¸€æ˜Ÿå·

                    // 7.2. "To: xxx" (ä¼˜é›…é‡‘è‰² - Cinzel)
                    if (toName) {
                        ctx.font = `500 48px "Cinzel", "Noto Serif SC", serif`;  // ä½¿ç”¨ medium weightï¼Œä¸è¦ bold
                        
                        // æŸ”å’Œé‡‘è‰²ï¼ˆä¸æ˜¯é‡‘å±æ¸å˜ï¼Œè€Œæ˜¯å•ä¸€æŸ”å’Œè‰²ï¼‰
                        ctx.fillStyle = '#B8956A';  // æŸ”å’Œé‡‘æ£•è‰²
                        
                        ctx.fillText(`To: ${toName}`, exportW / 2, textAreaTop + 45);
                    }

                    // 7.3. ç¥ç¦è¯­ (Warm Charcoal / Deep Forest Green)
                    if (message) {
                        ctx.font = `400 36px "Mountains of Christmas", "Noto Serif SC", serif`;  // ä½¿ç”¨ normal weight
                        ctx.fillStyle = '#2C3E2F';  // æ·±æ£®æ—ç»¿ï¼ˆæ¸©æš–åˆä¼˜é›…ï¼‰
                        // æˆ–è€…ä½¿ç”¨ï¼š ctx.fillStyle = '#333333';  // æ¸©æš–æ·±ç°è‰²

                        // æ·»åŠ æç»†çš„é˜´å½±ï¼ˆå¯é€‰ï¼‰
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.08)';
                        ctx.shadowBlur = 2;
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 1;

                        const maxWidth = exportW - 140;
                        let yPos = textAreaTop + (toName ? 110 : 70);
                        
                        const testMetrics = ctx.measureText(message);
                        
                        if (testMetrics.width <= maxWidth) {
                            ctx.fillText(message, exportW / 2, yPos);
                        } else {
                            let line = '';
                            const chars = message.split('');
                            
                            for (let i = 0; i < chars.length; i++) {
                                const testLine = line + chars[i];
                                const metrics = ctx.measureText(testLine);
                                
                                if (metrics.width > maxWidth && line !== '') {
                                    ctx.fillText(line, exportW / 2, yPos);
                                    line = chars[i];
                                    yPos += 45;
                                } else {
                                    line = testLine;
                                }
                            }
                            if (line) {
                                ctx.fillText(line, exportW / 2, yPos);
                            }
                        }
                        
                        // æ¸…é™¤é˜´å½±
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                    }

                    // ========== 8. æç®€æ°´å° (Minimalist Signature) ==========
                    const logoY = exportH - 50;
                    
                    // å»æ‰åˆ†éš”çº¿ï¼Œåªä¿ç•™ä½è°ƒæ°´å°æ–‡å­—
                    ctx.font = `300 20px "Cinzel", "Noto Serif SC", serif`;  // æ›´è½»çš„å­—é‡
                    ctx.fillStyle = 'rgba(100, 100, 100, 0.15)';  // éå¸¸æ·¡çš„ç°è‰²
                    ctx.fillText('XMAS DREAM', exportW / 2, logoY);

                    // ========== 9. ç§»åŠ¨ç«¯å‹å¥½çš„å¯¼å‡º (Mobile-Friendly Export) ==========
                    tempCanvas.toBlob((blob) => {
                        if (!blob) {
                            console.error('è´ºå¡ç”Ÿæˆå¤±è´¥');
                            setCapturing(false);
                            return;
                        }

                        const url = URL.createObjectURL(blob);
                        
                        // æ£€æµ‹ç§»åŠ¨ç«¯
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        
                        if (isMobile) {
                            // ç§»åŠ¨ç«¯ï¼šåœ¨æ–°çª—å£æ‰“å¼€å›¾ç‰‡ï¼Œç”¨æˆ·å¯ä»¥é•¿æŒ‰ä¿å­˜
                            const newWindow = window.open(url, '_blank');
                            if (!newWindow) {
                                // Fallback: å¦‚æœå¼¹çª—è¢«é˜»æ­¢ï¼Œä½¿ç”¨ä¼ ç»Ÿä¸‹è½½
                                const link = document.createElement('a');
                                link.href = url;
                                link.download = `xmas-card-${Date.now()}.png`;
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                            setTimeout(() => {
                                URL.revokeObjectURL(url);
                                setCapturing(false);
                            }, 1000);
                        } else {
                            // æ¡Œé¢ç«¯ï¼šä½¿ç”¨ä¼ ç»Ÿä¸‹è½½
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = `xmas-card-${Date.now()}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            setTimeout(() => {
                                URL.revokeObjectURL(url);
                                setCapturing(false);
                            }, 100);
                        }
                    }, 'image/png', 0.95);
                }, 100);
            };
            
            const handleEnter = () => {
                setGenerated(true);
                setAudioPlaying(true);
                audioRef.current.play().catch(e=>console.log("Audio blocked", e));
                audioRef.current.loop = true;
            };

            return (
                <>
                    <div className="ui-layer">
                        {!generated && (
                            <div className="flex flex-col items-center justify-center h-full bg-black/95 text-white z-50 p-6 interactive">
                                <h1 className="cinzel text-5xl md:text-7xl text-yellow-500 mb-2 text-center drop-shadow-lg">DREAMY XMAS</h1>
                                <p className="text-gray-500 mb-4 uppercase tracking-widest text-xs">Custom Edition</p>
                                <div className="glass-panel p-8 rounded-xl flex flex-col items-center max-w-md w-full mb-8 interactive">
                                    <div className="w-full h-32 border border-dashed border-white/20 hover:border-yellow-500/50 rounded-lg flex flex-col items-center justify-center relative cursor-pointer transition bg-white/5 hover:bg-white/10">
                                        <input type="file" multiple accept="image/*" onChange={(e) => { if (e.target.files) setPhotos(prev => [...prev, ...Array.from(e.target.files).map(file => URL.createObjectURL(file))]); }} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" />
                                        <i className="fa-solid fa-images text-2xl text-white/50 mb-2"></i>
                                        <p className="text-sm text-gray-300">Upload Photos</p>
                                        <p className="text-xs text-gray-600 mt-1">{photos.length} selected</p>
                                    </div>
                                </div>
                                <div className="flex flex-col gap-4">
                                    <button onClick={handleEnter} disabled={photos.length===0} className="px-8 py-3 bg-white/10 hover:bg-white/20 border border-white/20 text-white rounded font-medium interactive disabled:opacity-30 tracking-wider transition">ENTER</button>
                                    <a href="xmas-gesture.html" className="px-8 py-3 text-yellow-500 border border-yellow-500/30 hover:bg-yellow-500/10 rounded font-medium text-center tracking-wider transition">TRY GESTURE MODE ğŸ„</a>
                                </div>
                            </div>
                        )}

                        {generated && (
                            <>
                                <div className="absolute top-0 w-full p-6 flex justify-between items-start pointer-events-none">
                                    <h2 className="cinzel text-xl text-yellow-500 drop-shadow-lg">{theme.name}</h2>
                                    <div className="flex gap-3 interactive">
                                        <button onClick={resetTree} className="icon-btn" title="Reset"><i className="fa-solid fa-rotate-right"></i></button>
                                        <button onClick={handleScreenshot} className="icon-btn" title="Capture"><i className="fa-solid fa-camera"></i></button>
                                        <button onClick={toggleAudio} className="icon-btn" title="Audio">{audioPlaying ? <i className="fa-solid fa-volume-high"></i> : <i className="fa-solid fa-volume-xmark"></i>}</button>
                                        <button onClick={() => {if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen();}} className="icon-btn" title="Fullscreen"><i className="fa-solid fa-expand"></i></button>
                                        <a href="xmas-gesture.html" className="icon-btn" title="Gesture Mode"><i className="fa-solid fa-hand"></i></a>
                                    </div>
                                </div>

                                <div className="absolute top-24 left-6 flex flex-col gap-3 interactive">
                                    {Object.values(PRESETS).map(p => (
                                        <button key={p.id} onClick={() => setTheme(p)} className={`glass-panel px-4 py-2 rounded-lg text-sm text-left transition hover:scale-105 flex items-center gap-2 ${theme.id === p.id ? 'border-yellow-500 text-yellow-500' : 'text-gray-300'}`}>
                                            <div className="w-3 h-3 rounded-full shadow-[0_0_5px_currentColor]" style={{backgroundColor: p.leaf}}></div> {p.name}
                                        </button>
                                    ))}
                                </div>

                                <div className="absolute bottom-6 right-6 flex flex-col items-end gap-3 pointer-events-none z-40">
                                    {/* è´ºå¡è¾“å…¥é¢æ¿ - ä»…å½“ activePanel ä¸º 'greeting' æ—¶æ˜¾ç¤º */}
                                    {activePanel === 'greeting' && (
                                        <div className="glass-panel p-4 rounded-xl interactive w-64 animate-fade-in relative mb-2 md:static md:mb-2 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 md:translate-x-0 md:translate-y-0">
                                            <div className="flex justify-between items-center mb-3">
                                                <h3 className="text-xs text-white/50 uppercase tracking-widest">Greeting Card</h3>
                                                <button onClick={() => setActivePanel(null)} className="text-white/50 hover:text-white text-sm"><i className="fa-solid fa-xmark"></i></button>
                                            </div>
                                            {/* æ³¨æ„ï¼šæ·»åŠ äº† value å±æ€§ä»¥ä¿æŒçŠ¶æ€ */}
                                            <input type="text" placeholder="To..." className="card-input" maxLength="20" value={toName} onChange={(e) => setToName(e.target.value)} />
                                            <textarea rows="2" placeholder="Message..." className="card-input" maxLength="50" style={{resize:'none'}} value={message} onChange={(e) => setMessage(e.target.value)}></textarea>
                                        </div>
                                    )}
                                    
                                    {/* é…è‰²é¢æ¿ - ä»…å½“ activePanel ä¸º 'color' æ—¶æ˜¾ç¤º */}
                                    {activePanel === 'color' && (
                                        <div className="glass-panel p-4 rounded-xl interactive flex flex-col gap-2 pointer-events-auto w-72 animate-fade-in relative mb-2 max-h-[70vh] overflow-y-auto">
                                            <div className="flex justify-between items-center mb-2 sticky top-0 bg-black/80 -mx-4 px-4 py-2 z-10">
                                                <h3 className="text-xs text-white/50 uppercase tracking-widest">Color Palette</h3>
                                                <button onClick={() => setActivePanel(null)} className="text-white/50 hover:text-white text-sm"><i className="fa-solid fa-xmark"></i></button>
                                            </div>
                                            
                                            {/* æ ‘ä½“ç»“æ„ */}
                                            <div className="text-[9px] text-white/30 uppercase tracking-wider mb-1 mt-1">Tree Elements</div>
                                            <div className="flex items-center justify-between gap-4 py-1 hover:bg-white/5 px-2 rounded transition">
                                                <span className="text-[11px] text-white/60 tracking-wide flex items-center gap-2">
                                                    <span>ğŸŒ¿</span>
                                                    <span>Leaves</span>
                                                </span>
                                                <input type="color" value={theme.leaf} onChange={(e) => setTheme({...theme, leaf: e.target.value})} />
                                            </div>
                                            <div className="flex items-center justify-between gap-4 py-1 hover:bg-white/5 px-2 rounded transition">
                                                <span className="text-[11px] text-white/60 tracking-wide flex items-center gap-2">
                                                    <span>ğŸ</span>
                                                    <span>Gifts</span>
                                                </span>
                                                <input type="color" value={theme.gift} onChange={(e) => setTheme({...theme, gift: e.target.value})} />
                                            </div>
                                            <div className="flex items-center justify-between gap-4 py-1 hover:bg-white/5 px-2 rounded transition">
                                                <span className="text-[11px] text-white/60 tracking-wide flex items-center gap-2">
                                                    <span>ğŸ’</span>
                                                    <span>Ornaments</span>
                                                </span>
                                                <input type="color" value={theme.ornament} onChange={(e) => setTheme({...theme, ornament: e.target.value})} />
                                            </div>
                                            
                                            {/* å‘å…‰å…ƒç´  */}
                                            <div className="text-[9px] text-white/30 uppercase tracking-wider mb-1 mt-2">Glowing Elements</div>
                                            <div className="flex items-center justify-between gap-4 py-1 hover:bg-white/5 px-2 rounded transition">
                                                <span className="text-[11px] text-white/60 tracking-wide flex items-center gap-2">
                                                    <span>ğŸ€</span>
                                                    <span>Ribbon</span>
                                                </span>
                                                <input type="color" value={theme.ribbon} onChange={(e) => setTheme({...theme, ribbon: e.target.value})} />
                                            </div>
                                            <div className="flex items-center justify-between gap-4 py-1 hover:bg-white/5 px-2 rounded transition">
                                                <span className="text-[11px] text-white/60 tracking-wide flex items-center gap-2">
                                                    <span>â­</span>
                                                    <span>Star & Lights</span>
                                                </span>
                                                <input type="color" value={theme.light} onChange={(e) => setTheme({...theme, light: e.target.value})} />
                                            </div>
                                            
                                            {/* ç¯å¢ƒ */}
                                            <div className="border-t border-white/10 my-2"></div>
                                            <div className="text-[9px] text-white/30 uppercase tracking-wider mb-1">Environment</div>
                                            <div className="flex items-center justify-between gap-4 py-1 hover:bg-white/5 px-2 rounded transition">
                                                <span className="text-[11px] text-white/60 tracking-wide flex items-center gap-2">
                                                    <span>ğŸŒŒ</span>
                                                    <span>Background</span>
                                                </span>
                                                <input type="color" value={theme.bg} onChange={(e) => setTheme({...theme, bg: e.target.value})} />
                                            </div>
                                        </div>
                                    )}

                                    {/* æŠ˜å åçš„æµ®åŠ¨æŒ‰é’®ç»„ */}
                                    <div className="flex gap-3 interactive pointer-events-auto">
                                        <button 
                                            onClick={() => setActivePanel(activePanel === 'greeting' ? null : 'greeting')} 
                                            className={`icon-btn ${activePanel === 'greeting' ? 'bg-yellow-500/20 text-yellow-500 border-yellow-500/50' : ''}`}
                                            title="Edit Card"
                                        >
                                            <i className="fa-solid fa-pen-to-square"></i>
                                        </button>
                                        <button 
                                            onClick={() => setActivePanel(activePanel === 'color' ? null : 'color')} 
                                            className={`icon-btn ${activePanel === 'color' ? 'bg-yellow-500/20 text-yellow-500 border-yellow-500/50' : ''}`}
                                            title="Colorize"
                                        >
                                            <i className="fa-solid fa-palette"></i>
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    <div id="canvas-container">
                        <Canvas shadows gl={{ preserveDrawingBuffer: true }} camera={{ position: [0, 0, 55], fov: 35 }} dpr={[1, 1.5]}>
                            <Suspense fallback={null}>
                                <Scene photos={photos} mode={focusId !== null ? 'FOCUS' : mode} setMode={setMode} focusId={focusId} setFocusId={setFocusId} theme={theme} toName={toName} message={message} capturing={capturing} />
                            </Suspense>
                        </Canvas>
                    </div>
                </>
            );
        }

        createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>



